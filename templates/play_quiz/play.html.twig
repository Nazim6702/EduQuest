{% extends 'base.html.twig' %}
{% block title %}Question {{ step + 1 }} / {{ total }}{% endblock %}
{% block body %}
    <section class="question-container">
        <h2>{{ question.texte }}</h2>

        <form method="post" action="{{ path('app_quiz_submit', {id: quiz.id, step: step}) }}">
            {% if question.type == constant('App\\Enum\\QuestionType::QCM') %}
                {% for answer in question.answers %}
                    <div>
                        <input type="radio" name="answer" value="{{ answer.id }}" required>
                        {{ answer.texte }}
                    </div>
                {% endfor %}
            {% elseif question.type == constant('App\\Enum\\QuestionType::TRUE_FALSE') %}
                {% for answer in question.answers %}
                    <div>
                        <input type="radio" name="answer" value="{{ answer.id }}" required>
                        {{ answer.texte }}
                    </div>
                {% endfor %}
            {% elseif question.type == constant('App\\Enum\\QuestionType::OPEN') %}
                <textarea name="answer_text" required rows="3" cols="50"></textarea>
            {% endif %}

            <button type="submit">Valider</button>
        </form>

        <div id="timer">Temps restant : <span id="countdown"></span> sec</div>
        <div id="global-timer">Temps global restant : <span id="global-countdown"></span> sec</div>
    </section>
    <div class="progress-bar">
        {% for q in quiz.questions %}
            {% set status = app.session.get('quiz_progress_' ~ quiz.id)[q.id] ?? 'pending' %}
            <div class="progress-box {{ status }}"></div>
        {% endfor %}
    </div>

    <style>
        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 40px;
        }
        .progress-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            background-color: #ccc;
        }
        .progress-box.correct {
            background-color: #4caf50;
        }
        .progress-box.wrong {
            background-color: #f44336;
        }
        .progress-box.pending {
            background-color: #9e9e9e;
        }
    </style>

    <script>

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        //temps restant propre à chaque question
        let timeLeft = {{ question.duration|default(30) }};
        let countdown = document.getElementById('countdown');
        countdown.innerText = timeLeft;
        let timer = setInterval(() => {
            timeLeft--;
            countdown.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                document.querySelector('form').submit();
            }
        }, 1000);

        //temps restant pour completer le quiz
        let globalTimeLeft = {{ globalRemaining }};
        let globalCountdown = document.getElementById('global-countdown');
        globalCountdown.innerText = formatTime(globalTimeLeft);
        let globalTimer = setInterval(() => {
            globalTimeLeft--;
            globalCountdown.innerText = formatTime(globalTimeLeft);
            if (globalTimeLeft <= 0) {
                clearInterval(globalTimer);
                alert("Temps global écoulé !");
                window.location.href = "{{ path('app_quiz_results', { id: quiz.id }) }}";
            }
        }, 1000);
    </script>
{% endblock %}
